@page "/"
@using TechNationFinanceiroApi.Models
@inject INotaFiscalService NotaFiscalService
@inject IJSRuntime JSRuntime
@using System.Globalization


<PageTitle>Dashboard</PageTitle>


    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-flex align-items-center justify-content-between">
                            <h4 class="mb-0 font-size-18">Dashboard</h4>
                        </div>
                    </div>
                </div>
                <br />

                <div class="row">
                    <div class="col-md-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-4">
                                    <span class="badge badge-soft-primary float-right">Daily</span>
                                    <h5 class="card-title mb-0">Valor Total das Notas Emitidas</h5>
                                </div>
                                <div class="row d-flex align-items-center mb-4">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            $17.21
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span class="text-muted">
                                            12.5% <i class="mdi mdi-arrow-up text-success"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="progress shadow-sm" style="height: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 57%;">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="col-md-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-4">
                                    <span class="badge badge-soft-primary float-right">Per Week</span>
                                    <h5 class="card-title mb-0">Valor total das notas emitidas (Sem cobrança)</h5>
                                </div>
                                <div class="row d-flex align-items-center mb-4">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            $1875.54
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span class="text-muted">
                                            18.71% <i class="mdi mdi-arrow-down text-danger"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="progress shadow-sm" style="height: 5px;">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 57%;">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="col-md-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-4">
                                    <span class="badge badge-soft-primary float-right">Per Month</span>
                                    <h5 class="card-title mb-0">Valor total das notas vencidas (Inadimplência)</h5>
                                </div>
                                <div class="row d-flex align-items-center mb-4">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            $784.62
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span class="text-muted">
                                            57% <i class="mdi mdi-arrow-up text-success"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="progress shadow-sm" style="height: 5px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 57%;">
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                    <div class="col-md-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-4">
                                    <span class="badge badge-soft-primary float-right">All Time</span>
                                    <h5 class="card-title mb-0">Valor total das notas a vencer</h5>
                                </div>
                                <div class="row d-flex align-items-center mb-4">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            1,15,187
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span class="text-muted">
                                            17.8% <i class="mdi mdi-arrow-down text-danger"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="progress shadow-sm" style="height: 5px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 57%;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-4">
                                    <span class="badge badge-soft-primary float-right">All Time</span>
                                    <h5 class="card-title mb-0">
                                        Valor total das notas pagas;
                                    </h5>
                                </div>
                                <div class="row d-flex align-items-center mb-4">
                                    <div class="col-8">
                                        <h2 class="d-flex align-items-center mb-0">
                                            1,15,187
                                        </h2>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span class="text-muted">
                                            17.8% <i class="mdi mdi-arrow-down text-danger"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="progress shadow-sm" style="height: 5px;">
                                    <div class="progress-bar bg-sencondary" role="progressbar" style="width: 57%;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-lg-12">

                        <div class="card">
                            <div class="card-body">

                                <div class="row">
                                    <div class="col-lg-12">
                                    <div>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <h4 class="card-title">Gráfico de evolução da receita recebida mês a mês</h4>
                                                        <RadzenChart>
                                                            <RadzenLineSeries Smooth="@smooth" Data="@receitaPorMes" CategoryProperty="Date" Title="Receita Recebida" ValueProperty="Valor">
                                                                <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                            </RadzenLineSeries>

                                                            <RadzenCategoryAxis Padding="20" />
                                                            <RadzenValueAxis Formatter="@FormatAsUSD">
                                                                <RadzenGridLines Visible="true" />
                                                                <RadzenAxisTitle Text="Valor da Receita Recebida em USD" />
                                                            </RadzenValueAxis>
                                                        </RadzenChart>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <div class="row align-items-center">
                                                                <div class="col">
                                                                    <h4 class="card-title"></h4>
                                                                    <p class="card-subtitle mb-4">

                                                                    </p>
                                                                    <h3>$7841.12 <span class="badge badge-soft-success float-right">+7.5%</span></h3>
                                                                </div>
                                                            </div>

                                                            <div id="sparkline1" class="mt-3"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>

                

                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div>
                                    <h4 class="card-title">Gráfico de evolução da inadimplência mês a mês</h4>
                                    <div class="col-lg-12">
                                 
                                        <!-- RadzenChart -->
                                        <RadzenChart>
                                            <RadzenAreaSeries Smooth="@smooth" Data="@inadimplenciaPorMes" CategoryProperty="Date" Title="Inadimplência" ValueProperty="Valor">
                                                <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                            </RadzenAreaSeries>

                                            <RadzenCategoryAxis Padding="20" />
                                            <RadzenValueAxis Formatter="@FormatAsUSD">
                                                <RadzenGridLines Visible="true" />
                                                <RadzenAxisTitle Text="Valor da Inadimplência em USD" />
                                            </RadzenValueAxis>
                                        </RadzenChart>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 border border-danger">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <h4 class="card-title">Total de Inadimplência</h4>
                                                <h3>1</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        </div>
                    </div>
            
                </div>
            </div>
        </div>
    </div>

   



@code {
    bool smooth = true;
    bool showDataLabels = false;
    List<DataItem> inadimplenciaPorMes = new List<DataItem>(); // Será preenchido dinamicamente
    List<DataItem> receitaPorMes = new List<DataItem>(); // Será preenchido dinamicamente
    NotaFiscal[] notasFiscais; // Definir como membro da classe

    protected override async Task OnInitializedAsync()
    {
        // Chame seu serviço para obter dados de notas fiscais
        notasFiscais = (await NotaFiscalService.GetNotasFiscais()).ToArray();

        // Inicializar a lista de inadimplência por mês
        InicializarInadimplenciaPorMes();

        // Inicializar a lista de receita por mês
        InicializarReceitaPorMes();
    }

    void InicializarInadimplenciaPorMes()
    {
        // Agrupar notas fiscais com status "Pagamento em Atraso" por mês e somar a inadimplência
        inadimplenciaPorMes = notasFiscais
            .Where(nota => nota.Status == "Pagamento em Atraso" && nota.DataCobranca.HasValue) // Considerar apenas notas com status adequado e data de cobrança
            .GroupBy(nota => new { Month = nota.DataCobranca.Value.Month, Year = nota.DataCobranca.Value.Year })
            .OrderBy(group => group.Key.Year)
            .ThenBy(group => group.Key.Month)
            .Select(group => new DataItem
                {
                    Date = $"{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(group.Key.Month)} {group.Key.Year}",
                    Valor = (double)group.Sum(nota => nota.Valor ?? 0)
                })
            .ToList();
    }

    void InicializarReceitaPorMes()
    {
        // Agrupar notas fiscais com status "Pagamento Realizado" por mês e somar a receita recebida
        receitaPorMes = notasFiscais
            .Where(nota => nota.Status == "Pagamento Realizado" && nota.DataPagamento.HasValue) // Considerar apenas notas com status adequado e data de pagamento
            .GroupBy(nota => new { Month = nota.DataPagamento.Value.Month, Year = nota.DataPagamento.Value.Year })
            .OrderBy(group => group.Key.Year)
            .ThenBy(group => group.Key.Month)
            .Select(group => new DataItem
                {
                    Date = $"{CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(group.Key.Month)} {group.Key.Year}",
                    Valor = (double)group.Sum(nota => nota.Valor ?? 0)
                })
            .ToList();
    }

    string FormatAsUSD(object value)
    {
        return ((double)value).ToString("C0", CultureInfo.CreateSpecificCulture("en-US"));
    }

    // Definição da classe DataItem diretamente usando os dados da NotaFiscal
    public class DataItem
    {
        public string Date { get; set; }
        public double Valor { get; set; }
    }
}
